<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>dynamic-load-apk | 小林子的博客</title>
  <meta name="author" content="linkingr">

  
  <meta name="description" content="新的开始">
  
  

  <link rel="alternate" href="/atom.xml" title="小林子的博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  
</head>

<body>
  <header id="header" class="inner"><nav>
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
</nav></header>
  <div id="content" class="inner"><article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <header>
    
  
    <h1 class="title">dynamic-load-apk</h1>
  

    <time datetime="2015-02-12T04:47:10.000Z">
  <span class="day">12</span><span class="month">2月</span>
</time>
  </header>
  <div class="entry-content">
    
      <h3 id="核心思想">核心思想</h3>
<p>通过DexClassLoader动态加载插件apk中的类文件，通过代理的activity，托管插件activity的展示。</p>
<h3 id="核心代码">核心代码</h3>
<p>DLPluginManager 单例类，提供给宿主Activity使用，核心方法loadApk</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> DLPluginPackage <span class="title">loadApk</span>(String dexPath) {</div><div class="line">        <span class="comment">// when loadApk is called by host apk, we assume that plugin is invoked by host.</span></div><div class="line">        mFrom = DLConstants.FROM_EXTERNAL;</div><div class="line">        PackageInfo packageInfo = mContext.getPackageManager().</div><div class="line">                getPackageArchiveInfo(dexPath, PackageManager.GET_ACTIVITIES);</div><div class="line">        <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">final</span> String packageName = packageInfo.packageName;</div><div class="line">        DLPluginPackage pluginPackage = mPackagesHolder.get(packageName);</div><div class="line">        <span class="keyword">if</span> (pluginPackage == <span class="keyword">null</span>) {</div><div class="line">            DexClassLoader dexClassLoader = createDexClassLoader(dexPath);</div><div class="line">            AssetManager assetManager = createAssetManager(dexPath);</div><div class="line">            Resources resources = createResources(assetManager);</div><div class="line">            pluginPackage = <span class="keyword">new</span> DLPluginPackage(packageName, dexPath, dexClassLoader, assetManager,</div><div class="line">                    resources, packageInfo);</div><div class="line">            mPackagesHolder.put(packageName, pluginPackage);</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> pluginPackage;</div><div class="line">}</div><div class="line"> </div><div class="line"><span class="keyword">private</span> DexClassLoader <span class="title">createDexClassLoader</span>(String dexPath) {</div><div class="line">        File dexOutputDir = mContext.getDir(<span class="string">"dex"</span>, Context.MODE_PRIVATE);</div><div class="line">        <span class="keyword">final</span> String dexOutputPath = dexOutputDir.getAbsolutePath();</div><div class="line">        DexClassLoader loader = <span class="keyword">new</span> DexClassLoader(dexPath, dexOutputPath, <span class="keyword">null</span>, mContext.getClassLoader());</div><div class="line">        <span class="keyword">return</span> loader;</div><div class="line">}</div><div class="line"><span class="keyword">private</span> AssetManager <span class="title">createAssetManager</span>(String dexPath) {</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            AssetManager assetManager = AssetManager.class.newInstance();</div><div class="line">            Method addAssetPath = assetManager.getClass().getMethod(<span class="string">"addAssetPath"</span>, String.class);</div><div class="line">            addAssetPath.invoke(assetManager, dexPath);</div><div class="line">            <span class="keyword">return</span> assetManager;</div><div class="line">        } <span class="keyword">catch</span> (Exception e) {</div><div class="line">            e.printStackTrace();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        }</div><div class="line">}</div><div class="line"><span class="keyword">private</span> Resources <span class="title">createResources</span>(AssetManager assetManager) {</div><div class="line">        Resources superRes = mContext.getResources();</div><div class="line">        Resources resources = <span class="keyword">new</span> Resources(assetManager, superRes.getDisplayMetrics(),</div><div class="line">                superRes.getConfiguration());</div><div class="line">        <span class="keyword">return</span> resources;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>createDexClassLoader生成了类加载器，dexPath是插件apk的绝对路径，dexOutputpath是宿主app的黑盒路径，只有这个路径才不会报出异常。</p>
<p>activity的工作主要是由ContextImpl来完成的， 它在activity中是一个叫做mBase的成员变量，注意到Context中有两个抽象方法getAssets和getResources，实际上context就是通过它们来获取资源的，这两个抽象方法的真正实现在ContextImpl中。也就是说，只要我们自己实现这两个方法，就可以解决资源问题了。这里通过反射，得到了dexPath的AssetManager和Resoruces对象，只要将这个获取的对象放在代理的Activity对应方法返回中，就可以正常的使用插件apk中的资源文件。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">@TargetApi(Build.VERSION_CODES.ICE_CREAM_SANDWICH)</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> startPluginActivityForResult(Context context, DLIntent dlIntent, <span class="keyword">int</span> requestCode) {</div><div class="line">        <span class="keyword">if</span> (mFrom == DLConstants.FROM_INTERNAL) {</div><div class="line">            dlIntent.setClassName(context, dlIntent.getPluginClass());</div><div class="line">            performStartActivityForResult(context, dlIntent, requestCode);</div><div class="line">            <span class="keyword">return</span> DLPluginManager.START_RESULT_SUCCESS;</div><div class="line">        }</div><div class="line">        String packageName = dlIntent.getPluginPackage();</div><div class="line">        <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"disallow null packageName."</span>);</div><div class="line">        }</div><div class="line">        DLPluginPackage pluginPackage = mPackagesHolder.get(packageName);</div><div class="line">        <span class="keyword">if</span> (pluginPackage == <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">return</span> START_RESULT_NO_PKG;</div><div class="line">        } </div><div class="line">        DexClassLoader classLoader = pluginPackage.classLoader;</div><div class="line">        String className = dlIntent.getPluginClass();</div><div class="line">        className = (className == <span class="keyword">null</span> ? pluginPackage.getDefaultActivity() : className);</div><div class="line">        <span class="keyword">if</span> (className.startsWith(<span class="string">"."</span>)) {</div><div class="line">            className = packageName + className;</div><div class="line">        }</div><div class="line">        <span class="keyword">Class</span>&lt;?&gt; clazz = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            clazz = classLoader.loadClass(className);</div><div class="line">        } <span class="keyword">catch</span> (ClassNotFoundException e) {</div><div class="line">            e.printStackTrace();</div><div class="line">            <span class="keyword">return</span> START_RESULT_NO_CLASS;</div><div class="line">        }</div><div class="line">        <span class="keyword">Class</span>&lt;? <span class="keyword">extends</span> Activity&gt; activityClass = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (DLBasePluginActivity.<span class="keyword">class</span>.isAssignableFrom(clazz)) {</div><div class="line">            activityClass = DLProxyActivity.<span class="keyword">class</span>;</div><div class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (DLBasePluginFragmentActivity.<span class="keyword">class</span>.isAssignableFrom(clazz)) {</div><div class="line">            activityClass = DLProxyFragmentActivity.<span class="keyword">class</span>;</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            <span class="keyword">return</span> START_RESULT_TYPE_ERROR;</div><div class="line">        }</div><div class="line">        dlIntent.putExtra(DLConstants.EXTRA_CLASS, className);</div><div class="line">        dlIntent.putExtra(DLConstants.EXTRA_PACKAGE, packageName);</div><div class="line">        dlIntent.setClass(mContext, activityClass);</div><div class="line">        performStartActivityForResult(context, dlIntent, requestCode);</div><div class="line">        <span class="keyword">return</span> START_RESULT_SUCCESS;</div><div class="line">    }</div></pre></td></tr></table></figure>

<p>DLIntent继承自Intent，里面有两个变量，mPluginPackage指插件apk的包名，mPluginClass指需要开启的Activity name，可以以.开头，如果不指定，将默认defaultActivity。</p>
<p>这里可以看到mPluginClass需要继承DLBasePluginActivity或者DLBasePluginFragmentActivity，然后指定了Intent的class为DLProxyActivity，这个DLProxyActivity是声明在宿主app里的代理Activity，所以其实跳转的是宿主app里的代理Activity，再由代理Activity展示目标Activity，我们来看具体代码是如何实现的。</p>
<p>在代理Activity中有一个核心对象DLProxyImpl，核心代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span>(Intent intent) {</div><div class="line">        mPackageName = intent.getStringExtra(DLConstants.EXTRA_PACKAGE);</div><div class="line">        mClass = intent.getStringExtra(DLConstants.EXTRA_CLASS);</div><div class="line">        Log.d(TAG, <span class="string">"mClass="</span> + mClass + <span class="string">" mPackageName="</span> + mPackageName);</div><div class="line">        mPluginManager = DLPluginManager.getInstance(mActivity);</div><div class="line">        mPluginPackage = mPluginManager.getPackage(mPackageName);</div><div class="line">        mAssetManager = mPluginPackage.assetManager;</div><div class="line">        mResources = mPluginPackage.resources;</div><div class="line">        initializeActivityInfo();</div><div class="line">        handleActivityInfo();</div><div class="line">        launchTargetActivity();</div><div class="line">}</div><div class="line"> </div><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeActivityInfo</span>() {</div><div class="line">        PackageInfo packageInfo = mPluginPackage.packageInfo;</div><div class="line">        <span class="keyword">if</span> ((packageInfo.activities != <span class="keyword">null</span>) && (packageInfo.activities.length &gt; <span class="number">0</span>)) {</div><div class="line">            <span class="keyword">if</span> (mClass == <span class="keyword">null</span>) {</div><div class="line">                mClass = packageInfo.activities[<span class="number">0</span>].name;</div><div class="line">            }</div><div class="line">            <span class="keyword">for</span> (ActivityInfo a : packageInfo.activities) {</div><div class="line">                <span class="keyword">if</span> (a.name.equals(mClass)) {</div><div class="line">                    mActivityInfo = a;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">}</div><div class="line"> </div><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleActivityInfo</span>() {</div><div class="line">        Log.d(TAG, <span class="string">"handleActivityInfo, theme="</span> + mActivityInfo.theme);</div><div class="line">        <span class="keyword">if</span> (mActivityInfo.theme &gt; <span class="number">0</span>) {</div><div class="line">            mActivity.setTheme(mActivityInfo.theme);</div><div class="line">        }</div><div class="line">        Theme superTheme = mActivity.getTheme();</div><div class="line">        mTheme = mResources.newTheme();</div><div class="line">        mTheme.setTo(superTheme);</div><div class="line">        <span class="comment">// TODO: handle mActivityInfo.launchMode here in the future.</span></div><div class="line">}</div><div class="line"> </div><div class="line"><span class="annotation">@TargetApi</span>(Build.VERSION_CODES.ICE_CREAM_SANDWICH)</div><div class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">launchTargetActivity</span>() {</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            Class&lt;?&gt; localClass = getClassLoader().loadClass(mClass);</div><div class="line">            Constructor&lt;?&gt; localConstructor = localClass.getConstructor(<span class="keyword">new</span> Class[] {});</div><div class="line">            Object instance = localConstructor.newInstance(<span class="keyword">new</span> Object[] {});</div><div class="line">            mRemoteActivity = (DLPlugin) instance;</div><div class="line">            ((DLProxy) mActivity).attach(mRemoteActivity, mPluginManager);</div><div class="line">            Log.d(TAG, <span class="string">"instance = "</span> + instance);</div><div class="line">            mRemoteActivity.attach(mActivity, mPluginPackage);</div><div class="line">            Bundle bundle = <span class="keyword">new</span> Bundle();</div><div class="line">            bundle.putInt(DLConstants.FROM, DLConstants.FROM_EXTERNAL);</div><div class="line">            mRemoteActivity.onCreate(bundle);</div><div class="line">        } <span class="keyword">catch</span> (Exception e) {</div><div class="line">            e.printStackTrace();</div><div class="line">        }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>onCreate中做的事情包括：把插件app的theme设置到当前activity，launch目标Activity对象。这里是通过代理Activity中展示目标Activity的view，目标Activity持有代理Activity对象，在目标Activity中完全使用代理Activity的生命周期。也就是说setContentView，onCreate，onStart，onStop实际上走的都是代理Activity的生命周期，而getAssets和getResources返回的都是DLPluginPackage中通过反射得到的插件Apk中的AssetsManager和Resources对象。</p>
<p>所以看到DLBasePluginActivity的代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="annotation">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attach</span>(Activity proxyActivity, DLPluginPackage pluginPackage) {</div><div class="line">        Log.d(TAG, <span class="string">"attach: proxyActivity= "</span> + proxyActivity);</div><div class="line">        mProxyActivity = (Activity)proxyActivity;</div><div class="line">        that = mProxyActivity;</div><div class="line">        mPluginPackage = pluginPackage;</div><div class="line">    }</div><div class="line">    <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span>(Bundle savedInstanceState) {</div><div class="line">        <span class="keyword">if</span> (savedInstanceState != <span class="keyword">null</span>) {</div><div class="line">            mFrom = savedInstanceState.getInt(DLConstants.FROM, DLConstants.FROM_INTERNAL);</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (mFrom == DLConstants.FROM_INTERNAL) {</div><div class="line">            <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">            mProxyActivity = <span class="keyword">this</span>;</div><div class="line">            that = mProxyActivity;</div><div class="line">        }</div><div class="line">        mPluginManager = DLPluginManager.getInstance(that);</div><div class="line">    }</div></pre></td></tr></table></figure>

<p>attach将代理Activity作为上下文Context传入，提供that指针，注意这才是真正的Context，而不是this指针，所以这个Activity巧妙的运用了代理Activity的生命周期和Context，实际是将view展示在了代理Activity上。</p>
<h3 id="DEMO">DEMO</h3>
<p>宿主工程TestLoad</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="inheritance"><span class="keyword">extends</span></span> <span class="title">ActionBarActivity</span> </span>{</div><div class="line">    @Override</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> onCreate(Bundle savedInstanceState) {</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        getSupportActionBar().setTitle(<span class="string">"测试动态加载"</span>);</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> onClick(View view) {</div><div class="line">        DLPluginManager dlPluginManager = DLPluginManager.getInstance(<span class="keyword">this</span>);</div><div class="line">        dlPluginManager.loadApk(<span class="string">"/mnt/sdcard/test.apk"</span>);</div><div class="line">        dlPluginManager.startPluginActivity(<span class="keyword">this</span>, <span class="keyword">new</span> DLIntent(<span class="string">"com.load.dex2.testload2"</span>, <span class="string">".MainActivity"</span>));</div><div class="line">    }</div><div class="line">}</div><div class="line"> </div><div class="line">manifest定义</div><div class="line">&lt;application</div><div class="line">        android:allowBackup=<span class="string">"true"</span></div><div class="line">        android:icon=<span class="string">"@drawable/ic_launcher"</span></div><div class="line">        android:label=<span class="string">"@string/app_name"</span></div><div class="line">        android:theme=<span class="string">"@style/AppTheme"</span>&gt;</div><div class="line">        &lt;activity</div><div class="line">            android:name=<span class="string">".MainActivity"</span></div><div class="line">            android:screenOrientation=<span class="string">"portrait"</span>&gt;</div><div class="line">            &lt;intent-filter&gt;</div><div class="line">                &lt;action android:name=<span class="string">"android.intent.action.MAIN"</span> /&gt;</div><div class="line">                &lt;category android:name=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</div><div class="line">            &lt;/intent-filter&gt;</div><div class="line">        &lt;/activity&gt;</div><div class="line">        &lt;activity</div><div class="line">            android:name=<span class="string">"com.ryg.dynamicload.DLProxyActivity"</span> <span class="comment">//注意这里是一定要声明的</span></div><div class="line">            android:label=<span class="string">"@string/app_name"</span> &gt;</div><div class="line">            &lt;intent-filter&gt;</div><div class="line">                &lt;action android:name=<span class="string">"com.ryg.dynamicload.proxy.activity.VIEW"</span> /&gt;</div><div class="line">                &lt;category android:name=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</div><div class="line">            &lt;/intent-filter&gt;</div><div class="line">        &lt;/activity&gt;</div><div class="line">&lt;/application&gt;</div></pre></td></tr></table></figure>

<p>插件工程TestLoad2</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="inheritance"><span class="keyword">extends</span></span> <span class="title">DLBasePluginActivity</span> </span>{</div><div class="line">    @Override</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> onCreate(Bundle savedInstanceState) {</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.acitivity_main);</div><div class="line">        that.setTitle(<span class="string">"哈哈哈"</span>);</div><div class="line">        findViewById(R.id.test).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() {</div><div class="line">            @Override</div><div class="line">            <span class="keyword">public</span> <span class="keyword">void</span> onClick(View v) {</div><div class="line">                startPluginActivity(<span class="keyword">new</span> DLIntent(getPackageName(), SecondActivity.class));</div><div class="line">            }</div><div class="line">        });</div><div class="line">    }</div><div class="line">}</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondActivity</span> <span class="inheritance"><span class="keyword">extends</span></span> <span class="title">DLBasePluginActivity</span> </span>{</div><div class="line">    @Override</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> onCreate(Bundle savedInstanceState) {</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.acitivity_second);</div><div class="line">    }</div><div class="line">}</div><div class="line"> </div><div class="line">manifest定义</div><div class="line">    &lt;application</div><div class="line">        android:allowBackup=<span class="string">"true"</span></div><div class="line">        android:icon=<span class="string">"@drawable/ic_launcher"</span></div><div class="line">        android:label=<span class="string">"@string/app_name"</span> &gt;</div><div class="line">        &lt;activity</div><div class="line">            android:name=<span class="string">".MainActivity"</span></div><div class="line">            android:screenOrientation=<span class="string">"portrait"</span></div><div class="line">            android:theme=<span class="string">"@style/Theme.AppCompat.Light"</span>&gt;</div><div class="line">            &lt;intent-filter&gt;</div><div class="line">                &lt;action android:name=<span class="string">"android.intent.action.MAIN"</span> /&gt;</div><div class="line">                &lt;category android:name=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</div><div class="line">            &lt;/intent-filter&gt;</div><div class="line">        &lt;/activity&gt;</div><div class="line">        &lt;activity</div><div class="line">            android:name=<span class="string">".SecondActivity"</span></div><div class="line">            android:theme=<span class="string">"@android:style/Theme.Holo.Light"</span> /&gt;</div><div class="line">    &lt;/application&gt;</div></pre></td></tr></table></figure>

<p>需要注意的问题：</p>
<p>1、目标apk在编译的时候需要把dl-lib.jar提供成provided，否则会有重复加载的异常。</p>
<p>2、manifest中需要定义每一个activity，虽然实际是在代理Activity中实现的，但如果不声明，会报空指针，因为获取目标Activity的theme时没有进行判空，另外这里的theme，如果是自己定义的theme貌似是不生效的。</p>

    
    
    <footer class="meta">
      
      
      
    </footer>
    
  </div>
  
</article></div>
  <footer id="footer" class="inner"><div class="social alignright">
  
  
  
  
  <a class="rss" href="/atom.xml" title="RSS">RSS</a>
</div>
<p>
  
  &copy; 2015 linkingr
  
</p>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<div id="phasebeam">
  <canvas></canvas>
  <canvas></canvas>
  <canvas></canvas>
</div>
<script src="/js/phasebeam.js"></script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Archives: 2014/4 | 小林子的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="新的开始">
<meta property="og:type" content="website">
<meta property="og:title" content="小林子的博客">
<meta property="og:url" content="http://blog.linkingr/archives/2014/04/">
<meta property="og:site_name" content="小林子的博客">
<meta property="og:description" content="新的开始">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小林子的博客">
<meta name="twitter:description" content="新的开始">

  
    <link rel="alternative" href="/atom.xml" title="小林子的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">小林子的博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://blog.linkingr"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-AsyncTask" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/04/24/AsyncTask/" class="article-date">
  <time datetime="2014-04-24T07:49:29.000Z" itemprop="datePublished">4月 24 2014</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/04/24/AsyncTask/">AsyncTask</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="AsyncTask的定义">AsyncTask的定义</h3>
<p>AsyncTask顾名思义，异步任务，是安卓api中提供的使你可以进行后台阻塞操作并且输出结果给ui线程的封装类。</p>
<h3 id="AsyncTask的用法">AsyncTask的用法</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractModelAsyncTask</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ConcurrentTask</span>&lt;<span class="title">Void</span>, <span class="title">Integer</span>, <span class="title">T</span>&gt; </span>{</div><div class="line">    <span class="keyword">private</span> Exception exception;</div><div class="line">    <span class="keyword">private</span> T data;</div><div class="line">    <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">protected</span> T <span class="title">doInBackground</span>(Void... voids) {</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            data = doLoadData();</div><div class="line">            exception = <span class="keyword">null</span>;</div><div class="line">        } <span class="keyword">catch</span> (Exception e) {</div><div class="line">            data = <span class="keyword">null</span>;</div><div class="line">            exception = e;</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> getData();</div><div class="line">    }</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> T <span class="title">doLoadData</span>() <span class="keyword">throws</span> Exception;</div><div class="line">    <span class="keyword">public</span> Exception <span class="title">getException</span>() {</div><div class="line">        <span class="keyword">return</span> exception;</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> T <span class="title">getData</span>() {</div><div class="line">        <span class="keyword">return</span> data;</div><div class="line">    }</div><div class="line">    <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span>(T t) {</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            <span class="keyword">if</span> (exception == <span class="keyword">null</span>) {</div><div class="line">                onSuccess(t);</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                onException(exception);</div><div class="line">            }</div><div class="line">        } <span class="keyword">catch</span> (Exception e) {</div><div class="line">            e.printStackTrace();</div><div class="line">        } <span class="keyword">finally</span> {</div><div class="line">            <span class="keyword">try</span> {</div><div class="line">                onFinally();</div><div class="line">            } <span class="keyword">catch</span> (Exception e) {</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSuccess</span>(T t) {</div><div class="line">    }</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onFinally</span>() {</div><div class="line">    }</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onException</span>(Exception exception) {</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>用法很简单，你只需要继承AsyncTask的类并且实现两个方法，首先是doInBackground方法，这个方法是运行在后台线程中的，一般做比如获取网络数据或者文件io这种阻塞线程的操作，另一个方法是onPostExecute，它相当于一开始说的对于ui线程的输出结果，把doInBackground的结果返回给ui线程。</p>
<h3 id="AsyncTask的源码实现">AsyncTask的源码实现</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="javadoc">/**</span></div><div class="line"> * Creates a new asynchronous task. This constructor must be invoked on the UI thread.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="title">ModernAsyncTask</span>() {</div><div class="line">    mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() {</div><div class="line">        <span class="keyword">public</span> Result <span class="title">call</span>() <span class="keyword">throws</span> Exception {</div><div class="line">            mTaskInvoked.set(<span class="keyword">true</span>);</div><div class="line">            Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">            <span class="keyword">return</span> postResult(doInBackground(mParams));</div><div class="line">        }</div><div class="line">    };</div><div class="line">    mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker) {</div><div class="line">        <span class="annotation">@Override</span></div><div class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span>() {</div><div class="line">            <span class="keyword">try</span> {</div><div class="line">                <span class="keyword">final</span> Result result = get();</div><div class="line">                postResultIfNotInvoked(result);</div><div class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</div><div class="line">                android.util.Log.w(LOG_TAG, e);</div><div class="line">            } <span class="keyword">catch</span> (ExecutionException e) {</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occured while executing doInBackground()"</span>,</div><div class="line">                        e.getCause());</div><div class="line">            } <span class="keyword">catch</span> (CancellationException e) {</div><div class="line">                postResultIfNotInvoked(<span class="keyword">null</span>);</div><div class="line">            } <span class="keyword">catch</span> (Throwable t) {</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occured while executing "</span></div><div class="line">                        + <span class="string">"doInBackground()"</span>, t);</div><div class="line">            }</div><div class="line">        }</div><div class="line">    };</div><div class="line">}</div></pre></td></tr></table></figure>

<p>首先来看初始化，woker是一个callable，实现了call方法，并且被传入一个futureTask中被持有，这个FutureTask只实现了done方法，那么FutureTask具体是怎样实现的呢？</p>
<p>FutureTask中有一个内部类Sync，继承自AbstractQueuedSynchronizer，简单点可以理解为是一个线程同步器，通过维护一个int值来表示状态，子类通过实现它的方法来管理状态，它包括排他模式和共享模式两种模式，表示当前同步器是否被线程独自持有，AbstractQueuedSynchronizer比较复杂也不细讲，感兴趣的可以看<a href="http://ifeve.com/introduce-abstractqueuedsynchronizer/" target="_blank" rel="external">http://ifeve.com/introduce-abstractqueuedsynchronizer/</a>，而FutureTask基本就是使用这个Sync对象操作了run，cancel和exception等操作。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">private <span class="keyword">static</span> final <span class="type">int</span> <span class="type">CORE_POOL_SIZE</span> = <span class="number">5</span>;</div><div class="line">private <span class="keyword">static</span> final <span class="type">int</span> <span class="type">MAXIMUM_POOL_SIZE</span> = <span class="number">128</span>;</div><div class="line">private <span class="keyword">static</span> final <span class="type">int</span> <span class="type">KEEP_ALIVE</span> = <span class="number">1</span>;</div><div class="line">private <span class="keyword">static</span> final <span class="type">ThreadFactory</span> sThreadFactory = new <span class="type">ThreadFactory</span>() {</div><div class="line">    private final <span class="type">AtomicInteger</span> mCount = new <span class="type">AtomicInteger</span>(<span class="number">1</span>);</div><div class="line">    public <span class="type">Thread</span> newThread(<span class="type">Runnable</span> r) {</div><div class="line">        <span class="keyword">return</span> new <span class="type">Thread</span>(r, <span class="string">"ModernAsyncTask #"</span> + mCount.getAndIncrement());</div><div class="line">    }</div><div class="line">};</div><div class="line">private <span class="keyword">static</span> final <span class="type">BlockingQueue</span>&lt;<span class="type">Runnable</span>&gt; sPoolWorkQueue =</div><div class="line">        new <span class="type">LinkedBlockingQueue</span>&lt;<span class="type">Runnable</span>&gt;(<span class="number">10</span>);</div><div class="line">/**</div><div class="line"> * <span class="type">An</span> {@link <span class="type">Executor</span>} that can be used to execute tasks <span class="keyword">in</span> parallel.</div><div class="line"> */</div><div class="line">public <span class="keyword">static</span> final <span class="type">Executor</span> <span class="type">THREAD_POOL_EXECUTOR</span></div><div class="line">        = new <span class="type">ThreadPoolExecutor</span>(<span class="type">CORE_POOL_SIZE</span>, <span class="type">MAXIMUM_POOL_SIZE</span>, <span class="type">KEEP_ALIVE</span>,</div><div class="line">                <span class="type">TimeUnit</span>.<span class="type">SECONDS</span>, sPoolWorkQueue, sThreadFactory);</div><div class="line">private <span class="keyword">static</span> final <span class="type">int</span> <span class="type">MESSAGE_POST_RESULT</span> = <span class="number">0x1</span>;</div><div class="line">private <span class="keyword">static</span> final <span class="type">int</span> <span class="type">MESSAGE_POST_PROGRESS</span> = <span class="number">0x2</span>;</div><div class="line">private <span class="keyword">static</span> final <span class="type">InternalHandler</span> sHandler = new <span class="type">InternalHandler</span>();</div><div class="line">private <span class="keyword">static</span> volatile <span class="type">Executor</span> sDefaultExecutor = <span class="type">THREAD_POOL_EXECUTOR</span>;</div><div class="line">private final <span class="type">WorkerRunnable</span>&lt;<span class="type">Params</span>, <span class="type">Result</span>&gt; mWorker;</div><div class="line">private final <span class="type">FutureTask</span>&lt;<span class="type">Result</span>&gt; mFuture;</div><div class="line">/**</div><div class="line"> * <span class="type">This</span> <span class="keyword">method</span> can be invoked <span class="keyword">from</span> {@link <span class="comment">#doInBackground} to</span></div><div class="line"> * publish updates on the <span class="type">UI</span> thread <span class="keyword">while</span> the background computation <span class="keyword">is</span></div><div class="line"> * still running. <span class="type">Each</span> call to this <span class="keyword">method</span> will trigger the execution <span class="keyword">of</span></div><div class="line"> * {@link <span class="comment">#onProgressUpdate} on the UI thread.</span></div><div class="line"> *</div><div class="line"> * {@link <span class="comment">#onProgressUpdate} will note be called if the task has been</span></div><div class="line"> * canceled.</div><div class="line"> *</div><div class="line"> * @param values <span class="type">The</span> progress values to update the <span class="type">UI</span> <span class="keyword">with</span>.</div><div class="line"> *</div><div class="line"> * @see <span class="comment">#onProgressUpdate</span></div><div class="line"> * @see <span class="comment">#doInBackground</span></div><div class="line"> */</div><div class="line">protected final <span class="type">void</span> publishProgress(<span class="type">Progress</span>... values) {//这个方法可以在doInBackground中自行调用，会回调onProgressUpdate方法，做一些进度相关的事情。</div><div class="line">    <span class="keyword">if</span> (!isCancelled()) {</div><div class="line">        sHandler.obtainMessage(<span class="type">MESSAGE_POST_PROGRESS</span>,</div><div class="line">                new <span class="type">AsyncTaskResult</span>&lt;<span class="type">Progress</span>&gt;(this, values)).sendToTarget();</div><div class="line">    }</div><div class="line">}</div><div class="line">private <span class="type">void</span> finish(<span class="type">Result</span> <span class="literal">result</span>) {</div><div class="line">    <span class="keyword">if</span> (isCancelled()) {</div><div class="line">        onCancelled(<span class="literal">result</span>);</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        onPostExecute(<span class="literal">result</span>);</div><div class="line">    }</div><div class="line">    mStatus = <span class="type">Status</span>.<span class="type">FINISHED</span>;</div><div class="line">}</div><div class="line">private <span class="keyword">static</span> class <span class="type">InternalHandler</span> extends <span class="type">Handler</span> {</div><div class="line">    @<span class="type">SuppressWarnings</span>({<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>})</div><div class="line">    @<span class="type">Override</span></div><div class="line">    public <span class="type">void</span> handleMessage(<span class="type">Message</span> msg) {</div><div class="line">        <span class="type">AsyncTaskResult</span> <span class="literal">result</span> = (<span class="type">AsyncTaskResult</span>) msg.obj;</div><div class="line">        switch (msg.what) {</div><div class="line">            <span class="keyword">case</span> <span class="type">MESSAGE_POST_RESULT</span>:</div><div class="line">                // <span class="type">There</span> <span class="keyword">is</span> only one <span class="literal">result</span></div><div class="line">                <span class="literal">result</span>.mTask.finish(<span class="literal">result</span>.mData[<span class="number">0</span>]);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="type">MESSAGE_POST_PROGRESS</span>:</div><div class="line">                <span class="literal">result</span>.mTask.onProgressUpdate(<span class="literal">result</span>.mData);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>除了这两个之外，还可以看到一些比较重要的初始化的类</p>
<p>1、ThreadFactory，创建一个线程，将runnable接口传入，接下来会看到哪里用到。</p>
<p>2、Executor，默认sDefaultExecutor是一个线程池，其中</p>
<p>@param corePoolSize the number of threads to keep in the pool, even if they are idle, unless {@code allowCoreThreadTimeOut} is set<br>@param maximumPoolSize the maximum number of threads to allow in the pool<br>@param keepAliveTime when the number of threads is greater than the core, this is the maximum time that excess idle threads  will wait for new tasks before terminating.<br>@param unit the time unit for the {@code keepAliveTime} argument<br>@param workQueue the queue to use for holding tasks before they are executed. This queue will hold only the {@code Runnable} tasks submitted by the {@code execute} method.<br>@param threadFactory the factory to use when the executor creates a new thread<br>可以注意到这里线程池是static的，所以不管你生成多少AsyncTask，由线程池是统一管理。</p>
<p>3、InternalHandler，后台线程对ui线程进行回调的handler<br>接下来讲一下整个过程具体是如何发生的？</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> final ModernAsyncTask&lt;Params, Progress, Result&gt; <span class="title">executeOnExecutor</span>(Executor exec,</div><div class="line">        Params... <span class="keyword">params</span>) {</div><div class="line">    <span class="keyword">if</span> (mStatus != Status.PENDING) {</div><div class="line">        <span class="keyword">switch</span> (mStatus) {</div><div class="line">            <span class="keyword">case</span> RUNNING:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                        + <span class="string">" the task is already running."</span>);</div><div class="line">            <span class="keyword">case</span> FINISHED:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                        + <span class="string">" the task has already been executed "</span></div><div class="line">                        + <span class="string">"(a task can be executed only once)"</span>);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    mStatus = Status.RUNNING;</div><div class="line">    onPreExecute();</div><div class="line">    mWorker.mParams = <span class="keyword">params</span>; <span class="comment">//这个参数赋给了WorkerRunnable中的Params[] mParams;，可以在之前初始化的代码中看到，它会传递给doInBackground的参数，使用Void表示不使用这个参数</span></div><div class="line">    exec.execute(mFuture);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>当我们调用AsyncTask的executeOnExecutor方法，首先会检查状态，之后会调用onPreExecute();方法，这个方法是在ui线程中的，做execute之前的一些操作，比如展示进度条。</p>
<p>exec是我们传入的Executor，拿刚才初始化时默认的sDefaultExecutor来说，将FutureTask作为参数传入。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span>(Runnable command) {</div><div class="line">    <span class="keyword">if</span> (command == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Proceed in 3 steps:</div><div class="line">     *</div><div class="line">     * 1. If fewer than corePoolSize threads are running, try to</div><div class="line">     * start a new thread with the given command as its first</div><div class="line">     * task.  The call to addWorker atomically checks runState and</div><div class="line">     * workerCount, and so prevents false alarms that would add</div><div class="line">     * threads when it shouldn't, by returning false.</div><div class="line">     *</div><div class="line">     * 2. If a task can be successfully queued, then we still need</div><div class="line">     * to double-check whether we should have added a thread</div><div class="line">     * (because existing ones died since last checking) or that</div><div class="line">     * the pool shut down since entry into this method. So we</div><div class="line">     * recheck state and if necessary roll back the enqueuing if</div><div class="line">     * stopped, or start a new thread if there are none.</div><div class="line">     *</div><div class="line">     * 3. If we cannot queue task, then we try to add a new</div><div class="line">     * thread.  If it fails, we know we are shut down or saturated</div><div class="line">     * and so reject the task.</div><div class="line">     */</div><div class="line">    <span class="keyword">int</span> c = ctl.get();</div><div class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) {</div><div class="line">        <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        c = ctl.get();</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (isRunning(c) && workQueue.offer(command)) {</div><div class="line">        <span class="keyword">int</span> recheck = ctl.get();</div><div class="line">        <span class="keyword">if</span> (! isRunning(recheck) && remove(command))</div><div class="line">            reject(command);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</div><div class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">    }</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</div><div class="line">        reject(command);</div><div class="line">}</div><div class="line"> </div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span>(Runnable firstTask, <span class="keyword">boolean</span> core) {</div><div class="line">    retry:</div><div class="line">    <span class="keyword">for</span> (;;) {</div><div class="line">        <span class="keyword">int</span> c = ctl.get();</div><div class="line">        <span class="keyword">int</span> rs = runStateOf(c);</div><div class="line">        <span class="comment">// Check if queue empty only if necessary.</span></div><div class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &&</div><div class="line">            ! (rs == SHUTDOWN &&</div><div class="line">               firstTask == <span class="keyword">null</span> &&</div><div class="line">               ! workQueue.isEmpty()))</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">for</span> (;;) {</div><div class="line">            <span class="keyword">int</span> wc = workerCountOf(c);</div><div class="line">            <span class="keyword">if</span> (wc &gt;= CAPACITY ||</div><div class="line">                wc &gt;= (core ? corePoolSize : maximumPoolSize))</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</div><div class="line">                <span class="keyword">break</span> retry;</div><div class="line">            c = ctl.get();  <span class="comment">// Re-read ctl</span></div><div class="line">            <span class="keyword">if</span> (runStateOf(c) != rs)</div><div class="line">                <span class="keyword">continue</span> retry;</div><div class="line">            <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">    Worker w = <span class="keyword">new</span> Worker(firstTask);</div><div class="line">    Thread t = w.thread;</div><div class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">    mainLock.lock();</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        <span class="comment">// Recheck while holding lock.</span></div><div class="line">        <span class="comment">// Back out on ThreadFactory failure or if</span></div><div class="line">        <span class="comment">// shut down before lock acquired.</span></div><div class="line">        <span class="keyword">int</span> c = ctl.get();</div><div class="line">        <span class="keyword">int</span> rs = runStateOf(c);</div><div class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span> ||</div><div class="line">            (rs &gt;= SHUTDOWN &&</div><div class="line">             ! (rs == SHUTDOWN &&</div><div class="line">                firstTask == <span class="keyword">null</span>))) {</div><div class="line">            decrementWorkerCount();</div><div class="line">            tryTerminate();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line">        workers.add(w);</div><div class="line">        <span class="keyword">int</span> s = workers.size();</div><div class="line">        <span class="keyword">if</span> (s &gt; largestPoolSize)</div><div class="line">            largestPoolSize = s;</div><div class="line">    } <span class="keyword">finally</span> {</div><div class="line">        mainLock.unlock();</div><div class="line">    }</div><div class="line">    t.start();</div><div class="line">    <span class="comment">// It is possible (but unlikely) for a thread to have been</span></div><div class="line">    <span class="comment">// added to workers, but not yet started, during transition to</span></div><div class="line">    <span class="comment">// STOP, which could result in a rare missed interrupt,</span></div><div class="line">    <span class="comment">// because Thread.interrupt is not guaranteed to have any effect</span></div><div class="line">    <span class="comment">// on a non-yet-started Thread (see Thread#interrupt).</span></div><div class="line">    <span class="keyword">if</span> (runStateOf(ctl.get()) == STOP && ! t.isInterrupted())</div><div class="line">        t.interrupt();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">}</div><div class="line"> </div><div class="line">    Worker(Runnable firstTask) {</div><div class="line">        <span class="keyword">this</span>.firstTask = firstTask;</div><div class="line">        <span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</div><div class="line">    }</div><div class="line">    <span class="javadoc">/** Delegates main run loop to outer runWorker  */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">        runWorker(<span class="keyword">this</span>);</div><div class="line">    }</div><div class="line">    <span class="keyword">final</span> <span class="keyword">void</span> runWorker(Worker w) {</div><div class="line">    Runnable task = w.firstTask;</div><div class="line">    w.firstTask = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">try</span> {</div><div class="line">        <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) {</div><div class="line">            w.lock();</div><div class="line">            clearInterruptsForTaskRun();</div><div class="line">            <span class="keyword">try</span> {</div><div class="line">                beforeExecute(w.thread, task);</div><div class="line">                Throwable thrown = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">try</span> {</div><div class="line">                    task.run();</div><div class="line">                } <span class="keyword">catch</span> (RuntimeException x) {</div><div class="line">                    thrown = x; <span class="keyword">throw</span> x;</div><div class="line">                } <span class="keyword">catch</span> (Error x) {</div><div class="line">                    thrown = x; <span class="keyword">throw</span> x;</div><div class="line">                } <span class="keyword">catch</span> (Throwable x) {</div><div class="line">                    thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</div><div class="line">                } <span class="keyword">finally</span> {</div><div class="line">                    afterExecute(task, thrown);</div><div class="line">                }</div><div class="line">            } <span class="keyword">finally</span> {</div><div class="line">                task = <span class="keyword">null</span>;</div><div class="line">                w.completedTasks++;</div><div class="line">                w.unlock();</div><div class="line">            }</div><div class="line">        }</div><div class="line">        completedAbruptly = <span class="keyword">false</span>;</div><div class="line">    } <span class="keyword">finally</span> {</div><div class="line">        processWorkerExit(w, completedAbruptly);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>当前线程池中运行的线程少于corePoolSize，就会将当前task加入到woker中，addWorker方法首先会有一些循环判断和重试的操作，异常流程返回false，正常流程会创建Woker对象，并开启线程，从类图中可以看到Worker类也是一个继承自AbstractQueuedSynchronizer的子类，this.thread = getThreadFactory().newThread(this);创建的就是我们一开始初始化时候说到的ThreadFactory，run方法的实现是将当前task以及等待队列中所有的task循环提交，等待队列task的获取是在getTask方法中，这里的task.run();就会调用到FutureTask的run方法，调用sync兑现的innerRun方法</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="type">void</span> innerRun() {</div><div class="line">    <span class="keyword">if</span> (!compareAndSetState(<span class="type">READY</span>, <span class="type">RUNNING</span>))</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    runner = <span class="type">Thread</span>.currentThread();</div><div class="line">    <span class="keyword">if</span> (getState() == <span class="type">RUNNING</span>) { // recheck after setting thread</div><div class="line">        V <span class="literal">result</span>;</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            <span class="literal">result</span> = callable.call();</div><div class="line">        } catch (<span class="type">Throwable</span> ex) {</div><div class="line">            setException(ex);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        }</div><div class="line">        <span class="type">set</span>(<span class="literal">result</span>);</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        releaseShared(<span class="number">0</span>); // cancel</div><div class="line">    }</div><div class="line">}</div><div class="line"> </div><div class="line"><span class="type">void</span> innerSet(V v) {</div><div class="line">    <span class="keyword">for</span> (;;) {</div><div class="line">        <span class="type">int</span> s = getState();</div><div class="line">        <span class="keyword">if</span> (s == <span class="type">RAN</span>)</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">if</span> (s == <span class="type">CANCELLED</span>) {</div><div class="line">            // aggressively release to <span class="type">set</span> runner to null,</div><div class="line">            // <span class="keyword">in</span> <span class="keyword">case</span> we are racing <span class="keyword">with</span> a cancel request</div><div class="line">            // that will <span class="keyword">try</span> to interrupt runner</div><div class="line">            releaseShared(<span class="number">0</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (compareAndSetState(s, <span class="type">RAN</span>)) {</div><div class="line">            <span class="literal">result</span> = v;</div><div class="line">            releaseShared(<span class="number">0</span>);</div><div class="line">            done();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>最后set(result)会调用sync的innerSet，最后调用done方法，看done方法的实现，就是将handler回调到ui线程，将result的结果onPostExecute回去。</p>
<p><img src="http://d.pcs.baidu.com/thumbnail/161aa844a30261297c50b5cbd52cfd80?fid=2265868045-250528-199519826094988&amp;time=1419667200&amp;sign=FDTAER-DCb740ccc5511e5e8fedcff06b081203-fkChVO1tB1mvud93a7mswm4aHGc%3D&amp;rt=sh&amp;expires=2h&amp;r=790902175&amp;sharesign=unknown&amp;size=c710_u500&amp;quality=100" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.linkingr/2014/04/24/AsyncTask/" data-id="0nje3stmn5vodeqm" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">October 2013</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2014/12/27/test/">什么是爱情</a>
          </li>
        
          <li>
            <a href="/2014/06/18/Handler-and-Looper/">Handler and Looper</a>
          </li>
        
          <li>
            <a href="/2014/05/07/Loaders/">Loaders</a>
          </li>
        
          <li>
            <a href="/2014/04/24/AsyncTask/">AsyncTask</a>
          </li>
        
          <li>
            <a href="/2013/10/17/android事件分发/">android事件分发</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2014 linkingr<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<script src="/js/script.js" type="text/javascript"></script>


  </div>
</body>
</html>
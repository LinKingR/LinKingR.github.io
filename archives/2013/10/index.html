<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Archives: 2013/10 | 小林子的博客</title>
  <meta name="author" content="linkingr">

  
  <meta name="description" content="新的开始">
  
  

  <link rel="alternate" href="/atom.xml" title="小林子的博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  
</head>

<body>
  <header id="header" class="inner"><nav>
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
</nav></header>
  <div id="content" class="inner">

<header id="archive-header">
  <h1 class="alignleft">Archives: 2013/10</h1>
  <div class="search alignright">
    <form action="http://google.com/search" method="get" accept-charset="utf-8">
      <input type="search" name="q" results="0" placeholder="Search">
      <input type="hidden" name="q" value="site:blog.linkingr">
    </form>
  </div>
</header>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <header>
    
  
    <h1 class="title"><a href="/2013/10/17/android事件分发/">android事件分发</a></h1>
  

    <time datetime="2013-10-17T10:09:16.000Z">
  <span class="day">17</span><span class="month">10月</span>
</time>
  </header>
  <div class="entry-content">
    
      <p>首先来说一个touch事件发生的时候，事件是如何传递和分发的呢？网上是这样说这个过程的，首先触发ACTIVITY的dispatchTouchEvent，然后触发ACTIVITY的onUserInteraction，然后触发LAYOUT的dispatchTouchEvent，然后触发LAYOUT的onInterceptTouchEvent。其实这个说法是正确的，只是还不够详细，接下来从源码上看看Android是怎么来做这件事情的。</p>
<p>任何一个touch事件都会由activity的dispatchTouchEvent方法先接收，至于为什么会在这里来接受这个event，我有待研究=。=…</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span>(MotionEvent ev)</div><div class="line">       <span class="title">if</span> (ev.<span class="title">getAction</span>() == MotionEvent.ACTION_DOWN) {</div><div class="line">           onUserInteraction();</div><div class="line">       }</div><div class="line">       <span class="keyword">if</span> (getWindow().superDispatchTouchEvent(ev)) {</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       }</div><div class="line">       <span class="keyword">return</span> onTouchEvent(ev);</div><div class="line">}</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUserInteraction</span>() {</div><div class="line">}</div><div class="line"> </div><div class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span>(MotionEvent event) {</div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>可以看到，onuserInteraction和onTouchEvent什么都没有做，当我继承了一个activity并且重写dispatchTouchEvent方法时，不管我reture true还是false，事件都被拦截住而没有传递到下层，只有调用super方法才能够正常的分发事件，我猜测分发事件的操作一定是发生在父类的dispatchTouchEvent中的，看代码只有这个superDispatchTouchEvent最为可疑，查看getWindow的实现类，也就是PhoneWindow的源码可以知道，这个方法中只有mDecormDecor.superDispatchTouchEvent(event)一句话，mDecor是window类组装出的继承自FrameLayout的rootView，会把你传入的contentView组装起来。代码如下:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installDecor</span>() {</div><div class="line">    <span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) {</div><div class="line">        mDecor = generateDecor();</div><div class="line">        mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</div><div class="line">        mDecor.setIsRootNamespace(<span class="keyword">true</span>);</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) {</div><div class="line">        mContentParent = generateLayout(mDecor);</div><div class="line"></div><div class="line">        mTitleView = (TextView)findViewById(com.android.internal.R.id.title);</div><div class="line">        <span class="keyword">if</span> (mTitleView != <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">if</span> ((getLocalFeatures() & (<span class="number">1</span> &lt;&lt; FEATURE_NO_TITLE)) != <span class="number">0</span>) {</div><div class="line">               View titleContainer = findViewById(com.android.internal.R.id.title_container);</div><div class="line">               <span class="keyword">if</span> (titleContainer != <span class="keyword">null</span>) {</div><div class="line">                   titleContainer.setVisibility(View.GONE);</div><div class="line">               } <span class="keyword">else</span> {</div><div class="line">                   mTitleView.setVisibility(View.GONE);</div><div class="line">               }</div><div class="line">               <span class="keyword">if</span> (mContentParent <span class="keyword">instanceof</span> FrameLayout) {</div><div class="line">                  ((FrameLayout)mContentParent).setForeground(<span class="keyword">null</span>);</div><div class="line">               }</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">               mTitleView.setText(mTitle);</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"> <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span>(<span class="keyword">int</span> layoutResID) {</div><div class="line">        <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) {</div><div class="line">            installDecor();</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            mContentParent.removeAllViews();</div><div class="line">        }</div><div class="line">        mLayoutInflater.inflate(layoutResID, mContentParent);</div><div class="line">        <span class="keyword">final</span> Callback cb = getCallback();</div><div class="line">        <span class="keyword">if</span> (cb != <span class="keyword">null</span> && !isDestroyed()) {</div><div class="line">            cb.onContentChanged();</div><div class="line">        }</div><div class="line">    }</div></pre></td></tr></table></figure>


<p> DecorView类中superDispatchTouchEvent只有一句话，super.dispatchTouchEvent(event);接下来就进入了ViewGroup的事件分发。</p>
<p>讲到ViewGroup的事件分发就要分成两个部分，一个是事件传递，也就是ViewGroup和深层view事件是如何传递的，另一个就是某一个具体的View或者ViewGroup是如何处理touch事件的。</p>
<p>既然源码调用了FrameLayout的dispatchTouchEvent，FrameLayout属于ViewGroup，就看它是怎么处理这个方法的，上源码:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span>(MotionEvent ev) {</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> action = ev.getAction();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">float</span> xf = ev.getX();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">float</span> yf = ev.getY();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">float</span> scrolledXFloat = xf + mScrollX;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">float</span> scrolledYFloat = yf + mScrollY;</div><div class="line">    <span class="keyword">final</span> Rect frame = mTempRect;</div><div class="line">    <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags & FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (action == MotionEvent.ACTION_DOWN) {</div><div class="line">        <span class="keyword">if</span> (mMotionTarget != <span class="keyword">null</span>) {</div><div class="line">            mMotionTarget = <span class="keyword">null</span>;</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (disallowIntercept || !onInterceptTouchEvent(ev)) {</div><div class="line">            ev.setAction(MotionEvent.ACTION_DOWN);</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> scrolledXInt = (<span class="keyword">int</span>) scrolledXFloat;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> scrolledYInt = (<span class="keyword">int</span>) scrolledYFloat;</div><div class="line">            <span class="keyword">final</span> View[] children = mChildren;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> count = mChildrenCount;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {</div><div class="line">                <span class="keyword">final</span> View child = children[i];</div><div class="line">                <span class="keyword">if</span> ((child.mViewFlags & VISIBILITY_MASK) == VISIBLE</div><div class="line">                        || child.getAnimation() != <span class="keyword">null</span>) {</div><div class="line">                    child.getHitRect(frame);</div><div class="line">                    <span class="keyword">if</span> (frame.contains(scrolledXInt, scrolledYInt)) {</div><div class="line">                        <span class="keyword">final</span> <span class="keyword">float</span> xc = scrolledXFloat - child.mLeft;</div><div class="line">                        <span class="keyword">final</span> <span class="keyword">float</span> yc = scrolledYFloat - child.mTop;</div><div class="line">                        ev.setLocation(xc, yc);</div><div class="line">                        child.mPrivateFlags &= ~CANCEL_NEXT_UP_EVENT;</div><div class="line">                        <span class="keyword">if</span> (child.dispatchTouchEvent(ev))  {</div><div class="line">                            mMotionTarget = child;</div><div class="line">                            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">boolean</span> isUpOrCancel = (action == MotionEvent.ACTION_UP) ||</div><div class="line">            (action == MotionEvent.ACTION_CANCEL);</div><div class="line">    <span class="keyword">if</span> (isUpOrCancel) {</div><div class="line">        mGroupFlags &= ~FLAG_DISALLOW_INTERCEPT;</div><div class="line">    }</div><div class="line">    <span class="keyword">final</span> View target = mMotionTarget;</div><div class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) {</div><div class="line">        ev.setLocation(xf, yf);</div><div class="line">        <span class="keyword">if</span> ((mPrivateFlags & CANCEL_NEXT_UP_EVENT) != <span class="number">0</span>) {</div><div class="line">            ev.setAction(MotionEvent.ACTION_CANCEL);</div><div class="line">            mPrivateFlags &= ~CANCEL_NEXT_UP_EVENT;</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(ev);</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (!disallowIntercept && onInterceptTouchEvent(ev)) {</div><div class="line">        <span class="keyword">final</span> <span class="keyword">float</span> xc = scrolledXFloat - (<span class="keyword">float</span>) target.mLeft;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">float</span> yc = scrolledYFloat - (<span class="keyword">float</span>) target.mTop;</div><div class="line">        mPrivateFlags &= ~CANCEL_NEXT_UP_EVENT;</div><div class="line">        ev.setAction(MotionEvent.ACTION_CANCEL);</div><div class="line">        ev.setLocation(xc, yc);</div><div class="line">        <span class="keyword">if</span> (!target.dispatchTouchEvent(ev)) {</div><div class="line">        }</div><div class="line">        mMotionTarget = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (isUpOrCancel) {</div><div class="line">        mMotionTarget = <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">final</span> <span class="keyword">float</span> xc = scrolledXFloat - (<span class="keyword">float</span>) target.mLeft;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">float</span> yc = scrolledYFloat - (<span class="keyword">float</span>) target.mTop;</div><div class="line">    ev.setLocation(xc, yc);</div><div class="line">    <span class="keyword">if</span> ((target.mPrivateFlags & CANCEL_NEXT_UP_EVENT) != <span class="number">0</span>) {</div><div class="line">        ev.setAction(MotionEvent.ACTION_CANCEL);</div><div class="line">        target.mPrivateFlags &= ~CANCEL_NEXT_UP_EVENT;</div><div class="line">        mMotionTarget = <span class="keyword">null</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> target.dispatchTouchEvent(ev);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>主要看前面这些行的代码，后面先不看，可以发现如果disallowIntercept和!onInterceptTouchEvent(ev)两者有一个为true，就会进入到条件判断中，disallowIntercept是指是否禁用掉事件拦截的功能，默认是false，也可以通过调用requestDisallowInterceptTouchEvent方法对这个值进行修改，接下来这个onInterceptTouchEvent就有意思了，可以看到判断条件进入后的语句是对childView的判断，找到event坐标对应的childView并调用子view的dispatchTouchEvent，所以这个onInterceptTouchEvent表示的是ViewGroup对事件的拦截，ViewGroup对onInterceptTouchEvent默认的实现只有一句话就是return false，也就是默认不拦截，如果onInterceptTouchEvent返回true或者没有找到对应的子view要怎么办呢，就由当前的viewGroup来处理事件，代码中可以看到，如果target为null，会调用父类的dispatchTouchEvent，也就是View的dispatchTouchEvent，接下来看View是如何来实现这个方法的。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> boolean <span class="title">dispatchTouchEvent</span>(MotionEvent <span class="keyword">event</span>) {</div><div class="line">    <span class="keyword">if</span> (mOnTouchListener != <span class="keyword">null</span> && (mViewFlags & ENABLED_MASK) == ENABLED &&</div><div class="line">            mOnTouchListener.onTouch(<span class="keyword">this</span>, <span class="keyword">event</span>)) {</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> onTouchEvent(<span class="keyword">event</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>第一个条件表示当前是否设置onTouchListener，第二个条件表示当前View是否设置enable，这里会首先回调onTouchListener的onTouch方法，可以看到这个onTouch方法的返回值直接影响了onTouchEvent是否被调用。当设置了onTouchListener并将返回值设置成true，则onTouchEvent不会被调用，否则会被调用，那么onTouchEvent做了什么事情呢？</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span>(MotionEvent event) {</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</div><div class="line">    <span class="keyword">if</span> ((viewFlags & ENABLED_MASK) == DISABLED) {</div><div class="line">        <span class="comment">// A disabled view that is clickable still consumes the touch</span></div><div class="line">        <span class="comment">// events, it just doesn't respond to them.</span></div><div class="line">        <span class="keyword">return</span> (((viewFlags & CLICKABLE) == CLICKABLE ||</div><div class="line">                (viewFlags & LONG_CLICKABLE) == LONG_CLICKABLE));</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (mTouchDelegate != <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">if</span> (mTouchDelegate.onTouchEvent(event)) {</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (((viewFlags & CLICKABLE) == CLICKABLE ||</div><div class="line">            (viewFlags & LONG_CLICKABLE) == LONG_CLICKABLE)) {</div><div class="line">        <span class="keyword">switch</span> (event.getAction()) {</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">                <span class="keyword">boolean</span> prepressed = (mPrivateFlags & PREPRESSED) != <span class="number">0</span>;</div><div class="line">                <span class="keyword">if</span> ((mPrivateFlags & PRESSED) != <span class="number">0</span> || prepressed) {</div><div class="line">                    <span class="comment">// take focus if we don't have it already and we should in</span></div><div class="line">                    <span class="comment">// touch mode.</span></div><div class="line">                    <span class="keyword">boolean</span> focusTaken = <span class="keyword">false</span>;</div><div class="line">                    <span class="keyword">if</span> (isFocusable() && isFocusableInTouchMode() && !isFocused()) {</div><div class="line">                        focusTaken = requestFocus();</div><div class="line">                    }</div><div class="line">                    <span class="keyword">if</span> (!mHasPerformedLongPress) {</div><div class="line">                        <span class="comment">// This is a tap, so remove the longpress check</span></div><div class="line">                        removeLongPressCallback();</div><div class="line">                        <span class="comment">// Only perform take click actions if we were in the pressed state</span></div><div class="line">                        <span class="keyword">if</span> (!focusTaken) {</div><div class="line">                            <span class="comment">// Use a Runnable and post this rather than calling</span></div><div class="line">                            <span class="comment">// performClick directly. This lets other visual state</span></div><div class="line">                            <span class="comment">// of the view update before click actions start.</span></div><div class="line">                            <span class="keyword">if</span> (mPerformClick == <span class="keyword">null</span>) {</div><div class="line">                                mPerformClick = <span class="keyword">new</span> PerformClick();</div><div class="line">                            }</div><div class="line">                            <span class="keyword">if</span> (!post(mPerformClick)) {</div><div class="line">                                performClick();</div><div class="line">                            }</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                    <span class="keyword">if</span> (mUnsetPressedState == <span class="keyword">null</span>) {</div><div class="line">                        mUnsetPressedState = <span class="keyword">new</span> UnsetPressedState();</div><div class="line">                    }</div><div class="line">                    <span class="keyword">if</span> (prepressed) {</div><div class="line">                        mPrivateFlags |= PRESSED;</div><div class="line">                        refreshDrawableState();</div><div class="line">                        postDelayed(mUnsetPressedState,</div><div class="line">                                ViewConfiguration.getPressedStateDuration());</div><div class="line">                    } <span class="keyword">else</span> <span class="keyword">if</span> (!post(mUnsetPressedState)) {</div><div class="line">                        <span class="comment">// If the post failed, unpress right now</span></div><div class="line">                        mUnsetPressedState.run();</div><div class="line">                    }</div><div class="line">                    removeTapCallback();</div><div class="line">                }</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</div><div class="line">                <span class="keyword">if</span> (mPendingCheckForTap == <span class="keyword">null</span>) {</div><div class="line">                    mPendingCheckForTap = <span class="keyword">new</span> CheckForTap();</div><div class="line">                }</div><div class="line">                mPrivateFlags |= PREPRESSED;</div><div class="line">                mHasPerformedLongPress = <span class="keyword">false</span>;</div><div class="line">                postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout());</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</div><div class="line">                mPrivateFlags &= ~PRESSED;</div><div class="line">                refreshDrawableState();</div><div class="line">                removeTapCallback();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> x = (<span class="keyword">int</span>) event.getX();</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> y = (<span class="keyword">int</span>) event.getY();</div><div class="line">                <span class="comment">// Be lenient about moving outside of buttons</span></div><div class="line">                <span class="keyword">int</span> slop = mTouchSlop;</div><div class="line">                <span class="keyword">if</span> ((x &lt; <span class="number">0</span> - slop) || (x &gt;= getWidth() + slop) ||</div><div class="line">                        (y &lt; <span class="number">0</span> - slop) || (y &gt;= getHeight() + slop)) {</div><div class="line">                    <span class="comment">// Outside button</span></div><div class="line">                    removeTapCallback();</div><div class="line">                    <span class="keyword">if</span> ((mPrivateFlags & PRESSED) != <span class="number">0</span>) {</div><div class="line">                        <span class="comment">// Remove any future long press/tap checks</span></div><div class="line">                        removeLongPressCallback();</div><div class="line">                        <span class="comment">// Need to switch from pressed to not pressed</span></div><div class="line">                        mPrivateFlags &= ~PRESSED;</div><div class="line">                        refreshDrawableState();</div><div class="line">                    }</div><div class="line">                }</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        }</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>可以看到在action为Action_Up的时候有对click和longPress情况的处理，可以看到当view是disable时直接返回是否clickable，否则才会处理touch事件，并且可以看到一个有意思的地方，就是返回结果，正常情况下是return true，clickable为false时会return false；这里有一点，如果在执行ACTION_DOWN的时候返回了false，后面一系列其它的action就不会再得到执行了。当dispatchTouchEvent在进行事件分发的时候，只有前一个action返回true，才会触发后一个action。</p>
<p>简单写一下事件分发的流程图<br><img src="http://d.pcs.baidu.com/thumbnail/97cbeafe74122d86202140082ab299c7?fid=2265868045-250528-360980669596598&amp;time=1419674400&amp;sign=FDTAER-DCb740ccc5511e5e8fedcff06b081203-p%2FevIvhJtc2usluSCcMur12TNUA%3D&amp;rt=sh&amp;expires=2h&amp;r=364682712&amp;sharesign=unknown&amp;size=c710_u500&amp;quality=100" alt=""></p>

    
    
    <footer class="meta">
      
      
      
    </footer>
    
  </div>
  
</article>
  

  <nav id="pagenavi">
  
  
  <div class="clearfix"></div>
</nav>
</div>
  <footer id="footer" class="inner"><div class="social alignright">
  
  
  
  
  <a class="rss" href="/atom.xml" title="RSS">RSS</a>
</div>
<p>
  
  &copy; 2015 linkingr
  
</p>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<div id="phasebeam">
  <canvas></canvas>
  <canvas></canvas>
  <canvas></canvas>
</div>
<script src="/js/phasebeam.js"></script>
</body>
</html>